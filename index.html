<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¬ì—…ê³„íšì„œ ìë™ ìƒì„±ê¸° (Gemini Powered)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2pdf CDN for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Marked.js CDN for Markdown to HTML conversion -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Custom styles for the generated content area */
        #reportOutput {
            min-height: 400px;
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            line-height: 1.6;
        }
        /* Style the Markdown output */
        #reportOutput h1 { font-size: 2em; margin-top: 1.5em; margin-bottom: 0.5em; font-weight: 700; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5em; }
        #reportOutput h2 { font-size: 1.5em; margin-top: 1.25em; margin-bottom: 0.5em; font-weight: 600; color: #1e3a8a; }
        #reportOutput h3 { font-size: 1.25em; margin-top: 1em; margin-bottom: 0.5em; font-weight: 600; color: #3b82f6; }
        #reportOutput p { margin-bottom: 1em; }
        #reportOutput ul, #reportOutput ol { margin-left: 1.5em; margin-bottom: 1em; list-style-type: disc; }
        #reportOutput li { margin-bottom: 0.5em; }

        .citation {
            font-size: 0.8rem;
            color: #4b5563;
            margin-top: 1em;
            border-top: 1px dashed #e5e7eb;
            padding-top: 0.5rem;
        }

        /* Loading indicator styling */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #ffffff;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">ğŸ’¡ ì‚¬ì—… ê³„íšì„œ ìë™ ìƒì„±ê¸°</h1>
        <p class="text-gray-500 mb-8">í•µì‹¬ ì •ë³´ë¥¼ ì…ë ¥í•˜ì‹œë©´, Geminiì˜ ì‹¬ì¸µ ë¦¬ì„œì¹˜(Google Search í™œìš©)ë¥¼ í†µí•´ ìƒì„¸í•œ ì‚¬ì—… ê³„íšì„œ ì´ˆì•ˆì„ ìƒì„±í•´ ë“œë¦½ë‹ˆë‹¤.</p>

        <!-- API Key Status Notification (Key is now provided by the user in the script) -->
        <div id="apiStatusMessage" class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-8 rounded-lg shadow-md">
            <div class="flex items-center">
                <svg class="h-6 w-6 text-blue-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                <p class="text-sm text-blue-800 font-semibold">
                    âœ¨ API í‚¤ë¥¼ ì…ë ¥í•  ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤!
                </p>
            </div>
            <p class="mt-2 text-sm text-blue-700">
                ìŠ¤í¬ë¦½íŠ¸ ì˜ì—­ì— ë°œê¸‰ë°›ìœ¼ì‹  í‚¤ë¥¼ ì…ë ¥í•˜ì‹œë©´ ì¦‰ì‹œ ì‚¬ì—… ê³„íšì„œ ì‘ì„±ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
        </div>
        

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- 1. Input Form Area -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit sticky top-4">
                <h2 class="text-xl font-semibold mb-4 text-blue-700">í•„ìˆ˜ ì…ë ¥ ì •ë³´ (íŒ€ì¥ìš©)</h2>
                <form id="planForm" class="space-y-4">
                    
                    <!-- 1. ì‚¬ì—… ê³„íšì„œ ì¢…ë¥˜ -->
                    <div>
                        <label for="planType" class="block text-sm font-medium text-gray-700">1. ì‚¬ì—… ê³„íšì„œ ì¢…ë¥˜</label>
                        <select id="planType" name="planType" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                            <option value="ì‹ ê·œ ì‚¬ì—… ì•„ì´í…œ ê¸°íš">ì‹ ê·œ ì‚¬ì—… ì•„ì´í…œ ê¸°íš</option>
                            <option value="ê¸°ì¡´ ì‚¬ì—… ê°œì„  ë° ì „ëµ">ê¸°ì¡´ ì‚¬ì—… ê°œì„  ë° ì „ëµ</option>
                            <option value="ë§ˆì¼€íŒ… ë° ì˜ì—… ê³„íš">ë§ˆì¼€íŒ… ë° ì˜ì—… ê³„íš</option>
                            <option value="íˆ¬ì ìœ ì¹˜ìš© ì‚¬ì—… ê³„íš">íˆ¬ì ìœ ì¹˜ìš© ì‚¬ì—… ê³„íš</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€ (ì•„ë˜ ì•„ì´ë””ì–´ì— ìƒì„¸ ì‘ì„±)</option>
                        </select>
                    </div>

                    <!-- 2. íŒ€ ì´ë¦„ -->
                    <div>
                        <label for="teamName" class="block text-sm font-medium text-gray-700">2. íŒ€/í”„ë¡œì íŠ¸ ì´ë¦„</label>
                        <input type="text" id="teamName" name="teamName" required placeholder="ì˜ˆ: í˜ì‹  ê¸°íšíŒ€, Project Titan"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>

                    <!-- 3. ëª©í‘œ ë° ë¹„ì „ -->
                    <div>
                        <label for="goal" class="block text-sm font-medium text-gray-700">3. ì „ì²´ ëª©í‘œ ë° ë¹„ì „</label>
                        <textarea id="goal" name="goal" rows="2" required placeholder="ì‚¬ì—…ì„ í†µí•´ ë‹¬ì„±í•˜ê³ ì í•˜ëŠ” ê¶ê·¹ì ì¸ ëª©í‘œ"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
                    </div>

                    <!-- 4. ê¸°ê°„ -->
                    <div>
                        <label for="period" class="block text-sm font-medium text-gray-700">4. ê³„íš ê¸°ê°„</label>
                        <input type="text" id="period" name="period" required placeholder="ì˜ˆ: 2025ë…„ 4ë¶„ê¸° ~ 2026ë…„ 3ë¶„ê¸° (1ë…„)"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>

                    <!-- 5. ì£¼ìš” ê³¼ì œ ë° ë§ˆì¼ìŠ¤í†¤ -->
                    <div>
                        <label for="tasks" class="block text-sm font-medium text-gray-700">5. ì£¼ìš” ê³¼ì œ ë° í•µì‹¬ ë§ˆì¼ìŠ¤í†¤</label>
                        <textarea id="tasks" name="tasks" rows="3" required placeholder="ì„±ê³µì„ ìœ„í•´ ë°˜ë“œì‹œ ìˆ˜í–‰í•´ì•¼ í•  ì£¼ìš” í™œë™ (3~5ê°€ì§€)"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
                    </div>

                    <!-- 6. ê¸°ëŒ€ íš¨ê³¼ -->
                    <div>
                        <label for="expectedEffects" class="block text-sm font-medium text-gray-700">6. ì •ëŸ‰ì /ì •ì„±ì  ê¸°ëŒ€ íš¨ê³¼</label>
                        <textarea id="expectedEffects" name="expectedEffects" rows="3" required placeholder="ë§¤ì¶œ ì¦ê°€, ë¹„ìš© ì ˆê°, ì‹œì¥ ì ìœ ìœ¨ í™•ë³´ ë“± êµ¬ì²´ì  ê¸°ëŒ€ì¹˜"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
                    </div>

                    <!-- 7. í•µì‹¬ ì‚¬ì—… ì•„ì´ë””ì–´ (ê°€ì¥ ì¤‘ìš”) -->
                    <div>
                        <label for="businessIdea" class="block text-sm font-bold text-gray-900">7. í•µì‹¬ ì‚¬ì—… ì•„ì´ë””ì–´ ë° ìƒì„¸ ì„¤ëª…</label>
                        <textarea id="businessIdea" name="businessIdea" rows="5" required placeholder="ì•„ì´ë””ì–´ì˜ ë°°ê²½, ëŒ€ìƒ ê³ ê°, ì œê³µ ê°€ì¹˜ ë“±ì„ ìƒì„¸íˆ ì„¤ëª…í•´ ì£¼ì„¸ìš”. (ì‹¬ì¸µ ë¦¬ì„œì¹˜ì˜ ê¸°ë°˜ì´ ë©ë‹ˆë‹¤.)"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
                    </div>

                    <button type="submit" id="generateBtn"
                        class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out disabled:bg-blue-400" disabled>
                        <span id="buttonText">ì‚¬ì—… ê³„íšì„œ ìƒì„± ì‹œì‘</span>
                        <div id="loadingSpinner" class="spinner ml-2 hidden"></div>
                    </button>
                </form>
            </div>

            <!-- 2. Output Area -->
            <div class="lg:col-span-2">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-900">ğŸ“„ ìƒì„±ëœ ì‚¬ì—… ê³„íšì„œ ì´ˆì•ˆ</h2>
                    <button id="downloadPdfBtn"
                        class="py-2 px-4 bg-green-500 text-white font-medium rounded-lg shadow-md hover:bg-green-600 transition duration-150 ease-in-out disabled:bg-green-300"
                        disabled>
                        PDFë¡œ ì €ì¥
                    </button>
                </div>
                
                <div id="reportOutput" class="prose max-w-none">
                    <!-- Initial message set by JavaScript -->
                    <p class="text-gray-600 font-bold">ğŸ‰ ëª¨ë“  ì¤€ë¹„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! í•„ìš”í•œ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  'ì‚¬ì—… ê³„íšì„œ ìƒì„± ì‹œì‘' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // =========================================================================================
        // âš ï¸ ì‚¬ìš©ì API í‚¤ ì…ë ¥ ì„¹ì…˜: ì—¬ê¸°ì— ë°œê¸‰ë°›ìœ¼ì‹  Gemini API í‚¤ë¥¼ í°ë”°ì˜´í‘œ ì•ˆì— ë„£ì–´ì£¼ì„¸ìš”.
        // ì˜ˆ: const USER_API_KEY = "AIzaSy...your_key_here";
        // =========================================================================================
        const USER_API_KEY = "YOUR_API_KEY_HERE"; 
        
        // í™˜ê²½ ë³€ìˆ˜ê°€ ì œê³µë˜ëŠ” ê²½ìš° ìš°ì„  ì‚¬ìš©í•˜ë©°, ì•„ë‹ ê²½ìš° ì‚¬ìš©ì ì…ë ¥ í‚¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        // '__api_key'ëŠ” Canvas í™˜ê²½ì—ì„œ ìë™ìœ¼ë¡œ ì£¼ì…ë˜ëŠ” ë³€ìˆ˜ì…ë‹ˆë‹¤.
        let API_KEY = (typeof __api_key !== 'undefined' && __api_key.length > 0) ? __api_key : USER_API_KEY;
        
        const API_BASE_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`;
        const MAX_RETRIES = 5;
        
        const form = document.getElementById('planForm');
        const reportOutput = document.getElementById('reportOutput');
        const generateBtn = document.getElementById('generateBtn');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const apiStatusMessageDiv = document.getElementById('apiStatusMessage');

        // Initial setup for the app state
        function initializeApp() {
            if (API_KEY && API_KEY !== "YOUR_API_KEY_HERE") {
                // í‚¤ê°€ ìœ íš¨í•˜ê²Œ ì„¤ì •ë¨ (í™˜ê²½ ë³€ìˆ˜ì´ë“ , ì‚¬ìš©ì ì…ë ¥ì´ë“ )
                generateBtn.disabled = false;
                reportOutput.innerHTML = `<p class="text-gray-600 font-bold">ğŸ‰ ëª¨ë“  ì¤€ë¹„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! í•„ìš”í•œ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  'ì‚¬ì—… ê³„íšì„œ ìƒì„± ì‹œì‘' ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>`;
                apiStatusMessageDiv.className = 'bg-green-50 border-l-4 border-green-400 p-4 mb-8 rounded-lg shadow-md';
                apiStatusMessageDiv.innerHTML = `<div class="flex items-center"><svg class="h-6 w-6 text-green-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p class="text-sm text-green-800 font-semibold">âœ¨ API í‚¤ ì„¤ì • ì™„ë£Œ!</p></div><p class="mt-2 text-sm text-green-700">ì´ì œ ë°”ë¡œ ì‚¬ì—… ê³„íšì„œ ì‘ì„±ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>`;

            } else {
                // í‚¤ê°€ ëˆ„ë½ë˜ì—ˆê±°ë‚˜ ê¸°ë³¸ Placeholder ë¬¸ìì—´ì„
                generateBtn.disabled = true;
                reportOutput.innerHTML = `<p class="text-red-500 font-bold">âš ï¸ API í‚¤ê°€ ì½”ë“œì— ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìœ„ì˜ ìŠ¤í¬ë¦½íŠ¸ ì„¹ì…˜ì—ì„œ í‚¤ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>`;
                apiStatusMessageDiv.className = 'bg-red-50 border-l-4 border-red-400 p-4 mb-8 rounded-lg shadow-md';
                 apiStatusMessageDiv.innerHTML = `<div class="flex items-center"><svg class="h-6 w-6 text-red-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.3 16c-.77 1.333.192 3 1.732 3z" /></svg><p class="text-sm text-red-800 font-semibold">âŒ API í‚¤ ì…ë ¥ í•„ìš”!</p></div><p class="mt-2 text-sm text-red-700">ì½”ë“œë¥¼ í¸ì§‘í•˜ì—¬ **USER_API_KEY** ë³€ìˆ˜ì— ë°œê¸‰ë°›ì€ í‚¤ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>`;
            }
        }

        // Initialize on load
        initializeApp();

        // --- Core API Logic (Using global API_KEY) ---

        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        const renderMarkdown = (markdownText) => {
            return marked.parse(markdownText);
        };

        async function fetchWithRetry(payload) {
            if (!API_KEY || API_KEY === "YOUR_API_KEY_HERE") {
                reportOutput.innerHTML = '<p class="text-red-600 font-bold">âŒ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ìƒì„±ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ ì„¹ì…˜ì— í‚¤ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>';
                return null;
            }

            const apiUrl = API_BASE_URL + API_KEY;

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return await response.json();
                    } else if (response.status === 401) {
                         // Unauthorized - likely bad key
                        reportOutput.innerHTML = `<p class="text-red-600">ì˜¤ë¥˜ ë°œìƒ: API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•Šê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í‚¤ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”. (ìƒíƒœ ì½”ë“œ: ${response.status})</p>`;
                        return null;
                    } else if (response.status === 429 || response.status >= 500) {
                        // Rate limit or server error: retry
                        const delay = Math.pow(2, i) * 1000 + (Math.random() * 1000);
                        console.warn(`[API] Retrying after error ${response.status}. Waiting for ${Math.round(delay / 1000)}s...`);
                        await wait(delay);
                    } else {
                        // Non-retryable error
                        const errorBody = await response.json();
                        console.error("[API] Fatal error, not retrying:", errorBody);
                        reportOutput.innerHTML = `<p class="text-red-600">ì˜¤ë¥˜ ë°œìƒ: API ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ìƒíƒœ ì½”ë“œ: ${response.status})</p>`;
                        return null;
                    }
                } catch (error) {
                    console.error("[API] Network error:", error);
                    if (i < MAX_RETRIES - 1) {
                        const delay = Math.pow(2, i) * 1000 + (Math.random() * 1000);
                        console.warn(`[API] Retrying after network error. Waiting for ${Math.round(delay / 1000)}s...`);
                        await wait(delay);
                    } else {
                        reportOutput.innerHTML = `<p class="text-red-600">ì˜¤ë¥˜ ë°œìƒ: ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë˜ëŠ” API í˜¸ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>`;
                        return null;
                    }
                }
            }
            return null;
        }


        async function generateBusinessPlan(event) {
            event.preventDefault();
            
            if (!API_KEY || API_KEY === "AIzaSyCF97FLOy-6bA2Qw9K_a5fKaqkjq_nN8BE") {
                // Using custom modal instead of alert()
                reportOutput.innerHTML = `<p class="text-red-600 font-bold">âŒ API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ìƒì„±ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ ì„¹ì…˜ì— í‚¤ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.</p>`;
                return;
            }

            // 1. Gather Input Data
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // 2. Prepare UI for generation
            reportOutput.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-blue-600">
                <div class="spinner border-blue-600 border-t-blue-300 w-8 h-8"></div>
                <p class="mt-4 font-semibold text-lg">ì‚¬ì—… ê³„íšì„œë¥¼ ì‹¬ì¸µ ë¦¬ì„œì¹˜ ì¤‘ì…ë‹ˆë‹¤...</p>
                <p class="text-sm text-gray-500 mt-1">ìµœëŒ€ 30ì´ˆ ì •ë„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
            </div>`;
            generateBtn.disabled = true;
            downloadPdfBtn.disabled = true;
            buttonText.textContent = "ìƒì„± ì¤‘...";
            loadingSpinner.classList.remove('hidden');

            // 3. Construct System Instruction and User Query (Korean prompts for high-quality response)
            const systemInstruction = {
                parts: [{
                    text: `ë‹¹ì‹ ì€ ì„¸ê³„ì ì¸ ìˆ˜ì¤€ì˜ ì „ë¬¸ ë¹„ì¦ˆë‹ˆìŠ¤ ì»¨ì„¤í„´íŠ¸ ë° ê¸ˆìœµ ë¶„ì„ê°€ì…ë‹ˆë‹¤.
                    ì‚¬ìš©ìê°€ ì œê³µí•œ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ì€ ëª©ì°¨ì™€ ë‚´ìš©ì„ í¬í•¨í•˜ëŠ” A4 2í˜ì´ì§€ ë¶„ëŸ‰ì˜ ìƒì„¸í•˜ê³  ì „ë¬¸ì ì¸ ì‚¬ì—… ê³„íšì„œ(Business Plan) ì´ˆì•ˆì„ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
                    
                    **[ë³´ê³ ì„œ ì‘ì„± ê°€ì´ë“œë¼ì¸]**
                    1.  **ì–¸ì–´:** ì „ì²´ ë³´ê³ ì„œëŠ” í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
                    2.  **í¬ë§·:** Markdown í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ë©°, ë¬¸ë²• ì˜¤ë¥˜ê°€ ì—†ë„ë¡ ëª…í™•í•˜ê²Œ êµ¬ì„±í•˜ì‹­ì‹œì˜¤.
                    3.  **ì‹¬ì¸µ ë¦¬ì„œì¹˜:** Google Search grounding toolì„ ì‚¬ìš©í•˜ì—¬ ìµœì‹  ì‹œì¥ ë™í–¥, í†µê³„, ê²½ìŸì‚¬ ì •ë³´ ë“± ê°ê´€ì ì¸ ê·¼ê±° ìë£Œë¥¼ ë°˜ë“œì‹œ í¬í•¨í•˜ì—¬ ë³´ê³ ì„œì˜ ê¹Šì´ì™€ ì‹ ë¢°ë„ë¥¼ ë†’ì´ì‹­ì‹œì˜¤.
                    4.  **ëª©ì°¨:** ë³´ê³ ì„œì—ëŠ” ë‹¤ìŒ ëª©ì°¨ë¥¼ í¬í•¨í•˜ì‹­ì‹œì˜¤.
                        -   # ì‚¬ì—… ê³„íšì„œ: [í•µì‹¬ ì‚¬ì—… ì•„ì´ë””ì–´ ì œëª©] (ë³´ê³ ì„œ ìµœìƒë‹¨ ì œëª©)
                        -   ## 1. ì‚¬ì—… ê°œìš” ë° ë°°ê²½
                        -   ## 2. ì‹œì¥ ë¶„ì„ ë° íƒ€ë‹¹ì„± (ë¦¬ì„œì¹˜ ê·¼ê±° í•„ìˆ˜)
                        -   ## 3. ì œí’ˆ/ì„œë¹„ìŠ¤ ìƒì„¸ ê¸°íš
                        -   ## 4. ì‹¤í–‰ ì „ëµ ë° ë§ˆì¼ìŠ¤í†¤
                        -   ## 5. ì¬ë¬´ ì˜ˆì¸¡ ë° ê¸°ëŒ€ íš¨ê³¼ (êµ¬ì²´ì ì¸ ìˆ˜ì¹˜ ì œì‹œ ë…¸ë ¥)
                        -   ## 6. ê²°ë¡  ë° ì œì–¸
                    
                    **[ì‚¬ìš©ì ì…ë ¥ ì •ë³´]**
                    ì‚¬ì—… ê³„íšì„œ ì¢…ë¥˜: ${data.planType}
                    íŒ€/í”„ë¡œì íŠ¸ ì´ë¦„: ${data.teamName}
                    ì „ì²´ ëª©í‘œ ë° ë¹„ì „: ${data.goal}
                    ê³„íš ê¸°ê°„: ${data.period}
                    ì£¼ìš” ê³¼ì œ ë° í•µì‹¬ ë§ˆì¼ìŠ¤í†¤: ${data.tasks}
                    ê¸°ëŒ€ íš¨ê³¼: ${data.expectedEffects}
                    í•µì‹¬ ì‚¬ì—… ì•„ì´ë””ì–´ ë° ìƒì„¸ ì„¤ëª…: ${data.businessIdea}

                    **[ìµœì¢… ì§€ì‹œ]** ì´ ëª¨ë“  ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‚¬ìš©ìì—ê²Œ ì œì¶œí•  ì™„ë²½í•œ ì´ˆì•ˆ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ì‹­ì‹œì˜¤. ëª¨ë“  ì„¹ì…˜ì€ ë‚´ìš©ì´ í’ë¶€í•˜ê³  ì „ë¬¸ì ì´ì–´ì•¼ í•©ë‹ˆë‹¤.`
                }]
            };

            const userQuery = `ìœ„ì˜ ì‹œìŠ¤í…œ ì§€ì¹¨ê³¼ ì‚¬ìš©ì ì…ë ¥ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, [${data.teamName}]ì˜ 'í•µì‹¬ ì‚¬ì—… ì•„ì´ë””ì–´: ${data.businessIdea}'ì— ëŒ€í•œ ìƒì„¸í•˜ê³  ì‹¬ì¸µì ì¸ ì‚¬ì—… ê³„íšì„œ ì´ˆì•ˆì„ ì‘ì„±í•˜ê³  ê´€ë ¨ ê·¼ê±° ìë£Œë¥¼ ë°˜ì˜í•˜ì‹­ì‹œì˜¤.`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: systemInstruction,
            };

            // 4. Call API with retry logic
            const result = await fetchWithRetry(payload);

            // 5. Process and Display Result
            if (result && result.candidates && result.candidates.length > 0) {
                const candidate = result.candidates[0];
                const generatedText = candidate.content?.parts?.[0]?.text || 'ë‚´ìš© ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';

                let sourcesHtml = '';
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    const sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);

                    if (sources.length > 0) {
                        sourcesHtml = '<div class="citation"><strong>ğŸ”— ì°¸ê³  ìë£Œ (Google Search):</strong><ul class="list-disc ml-4 mt-2">';
                        sources.forEach(source => {
                            sourcesHtml += `<li><a href="${source.uri}" target="_blank" class="text-blue-600 hover:underline text-sm">${source.title}</a></li>`;
                        });
                        sourcesHtml += '</ul></div>';
                    }
                }
                
                reportOutput.innerHTML = renderMarkdown(generatedText) + sourcesHtml;
                downloadPdfBtn.disabled = false;
            } else {
                if (!reportOutput.innerHTML.includes("ì˜¤ë¥˜ ë°œìƒ:")) {
                   reportOutput.innerHTML = `<p class="text-red-600 font-bold">âŒ ê²°ê³¼ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. API í‚¤ê°€ ì •í™•í•œì§€ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</p>`;
                }
                downloadPdfBtn.disabled = true;
            }

            // 6. Reset UI
            generateBtn.disabled = false;
            buttonText.textContent = "ì‚¬ì—… ê³„íšì„œ ìƒì„± ì‹œì‘";
            loadingSpinner.classList.add('hidden');
        }

        function downloadPdf() {
            const element = document.getElementById('reportOutput');
            const teamName = document.getElementById('teamName').value || 'BusinessPlan';
            
            const opt = {
                margin: 1,
                filename: `${teamName}_ì‚¬ì—…ê³„íšì„œ.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
                jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' }
            };

            // Use the markdown content directly for better PDF rendering
            html2pdf().set(opt).from(element).save();
        }

        form.addEventListener('submit', generateBusinessPlan);
        downloadPdfBtn.addEventListener('click', downloadPdf);
    </script>
</body>
</html>
