<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사업계획서 자동 생성기 (Gemini Powered)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2pdf CDN for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Marked.js CDN for Markdown to HTML conversion -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        /* Custom styles for the generated content area */
        #reportOutput {
            min-height: 400px;
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            line-height: 1.6;
        }
        /* Style the Markdown output */
        #reportOutput h1 { font-size: 2em; margin-top: 1.5em; margin-bottom: 0.5em; font-weight: 700; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5em; }
        #reportOutput h2 { font-size: 1.5em; margin-top: 1.25em; margin-bottom: 0.5em; font-weight: 600; color: #1e3a8a; }
        #reportOutput h3 { font-size: 1.25em; margin-top: 1em; margin-bottom: 0.5em; font-weight: 600; color: #3b82f6; }
        #reportOutput p { margin-bottom: 1em; }
        #reportOutput ul, #reportOutput ol { margin-left: 1.5em; margin-bottom: 1em; list-style-type: disc; }
        #reportOutput li { margin-bottom: 0.5em; }

        .citation {
            font-size: 0.8rem;
            color: #4b5563;
            margin-top: 1em;
            border-top: 1px dashed #e5e7eb;
            padding-top: 0.5rem;
        }

        /* Loading indicator styling */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #ffffff;
            width: 1.5rem;
            height: 1.5rem;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">💡 사업 계획서 자동 생성기</h1>
        <p class="text-gray-500 mb-8">핵심 정보를 입력하시면, Gemini의 심층 리서치(Google Search 활용)를 통해 상세한 사업 계획서 초안을 생성해 드립니다.</p>

        <!-- API Key Status Notification (Key is now provided by the user in the script) -->
        <div id="apiStatusMessage" class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-8 rounded-lg shadow-md">
            <div class="flex items-center">
                <svg class="h-6 w-6 text-blue-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                <p class="text-sm text-blue-800 font-semibold">
                    ✨ API 키를 입력할 준비가 되었습니다!
                </p>
            </div>
            <p class="mt-2 text-sm text-blue-700">
                스크립트 영역에 발급받으신 키를 입력하시면 즉시 사업 계획서 작성을 시작할 수 있습니다.
            </p>
        </div>
        

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- 1. Input Form Area -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit sticky top-4">
                <h2 class="text-xl font-semibold mb-4 text-blue-700">필수 입력 정보 (팀장용)</h2>
                <form id="planForm" class="space-y-4">
                    
                    <!-- 1. 사업 계획서 종류 -->
                    <div>
                        <label for="planType" class="block text-sm font-medium text-gray-700">1. 사업 계획서 종류</label>
                        <select id="planType" name="planType" required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                            <option value="신규 사업 아이템 기획">신규 사업 아이템 기획</option>
                            <option value="기존 사업 개선 및 전략">기존 사업 개선 및 전략</option>
                            <option value="마케팅 및 영업 계획">마케팅 및 영업 계획</option>
                            <option value="투자 유치용 사업 계획">투자 유치용 사업 계획</option>
                            <option value="기타">기타 (아래 아이디어에 상세 작성)</option>
                        </select>
                    </div>

                    <!-- 2. 팀 이름 -->
                    <div>
                        <label for="teamName" class="block text-sm font-medium text-gray-700">2. 팀/프로젝트 이름</label>
                        <input type="text" id="teamName" name="teamName" required placeholder="예: 혁신 기획팀, Project Titan"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>

                    <!-- 3. 목표 및 비전 -->
                    <div>
                        <label for="goal" class="block text-sm font-medium text-gray-700">3. 전체 목표 및 비전</label>
                        <textarea id="goal" name="goal" rows="2" required placeholder="사업을 통해 달성하고자 하는 궁극적인 목표"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
                    </div>

                    <!-- 4. 기간 -->
                    <div>
                        <label for="period" class="block text-sm font-medium text-gray-700">4. 계획 기간</label>
                        <input type="text" id="period" name="period" required placeholder="예: 2025년 4분기 ~ 2026년 3분기 (1년)"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>

                    <!-- 5. 주요 과제 및 마일스톤 -->
                    <div>
                        <label for="tasks" class="block text-sm font-medium text-gray-700">5. 주요 과제 및 핵심 마일스톤</label>
                        <textarea id="tasks" name="tasks" rows="3" required placeholder="성공을 위해 반드시 수행해야 할 주요 활동 (3~5가지)"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
                    </div>

                    <!-- 6. 기대 효과 -->
                    <div>
                        <label for="expectedEffects" class="block text-sm font-medium text-gray-700">6. 정량적/정성적 기대 효과</label>
                        <textarea id="expectedEffects" name="expectedEffects" rows="3" required placeholder="매출 증가, 비용 절감, 시장 점유율 확보 등 구체적 기대치"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
                    </div>

                    <!-- 7. 핵심 사업 아이디어 (가장 중요) -->
                    <div>
                        <label for="businessIdea" class="block text-sm font-bold text-gray-900">7. 핵심 사업 아이디어 및 상세 설명</label>
                        <textarea id="businessIdea" name="businessIdea" rows="5" required placeholder="아이디어의 배경, 대상 고객, 제공 가치 등을 상세히 설명해 주세요. (심층 리서치의 기반이 됩니다.)"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"></textarea>
                    </div>

                    <button type="submit" id="generateBtn"
                        class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out disabled:bg-blue-400" disabled>
                        <span id="buttonText">사업 계획서 생성 시작</span>
                        <div id="loadingSpinner" class="spinner ml-2 hidden"></div>
                    </button>
                </form>
            </div>

            <!-- 2. Output Area -->
            <div class="lg:col-span-2">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-900">📄 생성된 사업 계획서 초안</h2>
                    <button id="downloadPdfBtn"
                        class="py-2 px-4 bg-green-500 text-white font-medium rounded-lg shadow-md hover:bg-green-600 transition duration-150 ease-in-out disabled:bg-green-300"
                        disabled>
                        PDF로 저장
                    </button>
                </div>
                
                <div id="reportOutput" class="prose max-w-none">
                    <!-- Initial message set by JavaScript -->
                    <p class="text-gray-600 font-bold">🎉 모든 준비가 완료되었습니다! 필요한 정보를 입력하고 '사업 계획서 생성 시작' 버튼을 눌러주세요.</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // =========================================================================================
        // ⚠️ 사용자 API 키 입력 섹션: 여기에 발급받으신 Gemini API 키를 큰따옴표 안에 넣어주세요.
        // 예: const USER_API_KEY = "AIzaSy...your_key_here";
        // =========================================================================================
        const USER_API_KEY = "YOUR_API_KEY_HERE"; 
        
        // 환경 변수가 제공되는 경우 우선 사용하며, 아닐 경우 사용자 입력 키를 사용합니다.
        // '__api_key'는 Canvas 환경에서 자동으로 주입되는 변수입니다.
        let API_KEY = (typeof __api_key !== 'undefined' && __api_key.length > 0) ? __api_key : USER_API_KEY;
        
        const API_BASE_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`;
        const MAX_RETRIES = 5;
        
        const form = document.getElementById('planForm');
        const reportOutput = document.getElementById('reportOutput');
        const generateBtn = document.getElementById('generateBtn');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const apiStatusMessageDiv = document.getElementById('apiStatusMessage');

        // Initial setup for the app state
        function initializeApp() {
            if (API_KEY && API_KEY !== "YOUR_API_KEY_HERE") {
                // 키가 유효하게 설정됨 (환경 변수이든, 사용자 입력이든)
                generateBtn.disabled = false;
                reportOutput.innerHTML = `<p class="text-gray-600 font-bold">🎉 모든 준비가 완료되었습니다! 필요한 정보를 입력하고 '사업 계획서 생성 시작' 버튼을 눌러주세요.</p>`;
                apiStatusMessageDiv.className = 'bg-green-50 border-l-4 border-green-400 p-4 mb-8 rounded-lg shadow-md';
                apiStatusMessageDiv.innerHTML = `<div class="flex items-center"><svg class="h-6 w-6 text-green-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p class="text-sm text-green-800 font-semibold">✨ API 키 설정 완료!</p></div><p class="mt-2 text-sm text-green-700">이제 바로 사업 계획서 작성을 시작할 수 있습니다.</p>`;

            } else {
                // 키가 누락되었거나 기본 Placeholder 문자열임
                generateBtn.disabled = true;
                reportOutput.innerHTML = `<p class="text-red-500 font-bold">⚠️ API 키가 코드에 설정되지 않았습니다. 위의 스크립트 섹션에서 키를 입력해 주세요.</p>`;
                apiStatusMessageDiv.className = 'bg-red-50 border-l-4 border-red-400 p-4 mb-8 rounded-lg shadow-md';
                 apiStatusMessageDiv.innerHTML = `<div class="flex items-center"><svg class="h-6 w-6 text-red-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.3 16c-.77 1.333.192 3 1.732 3z" /></svg><p class="text-sm text-red-800 font-semibold">❌ API 키 입력 필요!</p></div><p class="mt-2 text-sm text-red-700">코드를 편집하여 **USER_API_KEY** 변수에 발급받은 키를 입력해 주세요.</p>`;
            }
        }

        // Initialize on load
        initializeApp();

        // --- Core API Logic (Using global API_KEY) ---

        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        const renderMarkdown = (markdownText) => {
            return marked.parse(markdownText);
        };

        async function fetchWithRetry(payload) {
            if (!API_KEY || API_KEY === "YOUR_API_KEY_HERE") {
                reportOutput.innerHTML = '<p class="text-red-600 font-bold">❌ API 키가 설정되지 않아 생성을 시작할 수 없습니다. 스크립트 섹션에 키를 입력해 주세요.</p>';
                return null;
            }

            const apiUrl = API_BASE_URL + API_KEY;

            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return await response.json();
                    } else if (response.status === 401) {
                         // Unauthorized - likely bad key
                        reportOutput.innerHTML = `<p class="text-red-600">오류 발생: API 키가 유효하지 않거나 만료되었습니다. 키를 확인해 주세요. (상태 코드: ${response.status})</p>`;
                        return null;
                    } else if (response.status === 429 || response.status >= 500) {
                        // Rate limit or server error: retry
                        const delay = Math.pow(2, i) * 1000 + (Math.random() * 1000);
                        console.warn(`[API] Retrying after error ${response.status}. Waiting for ${Math.round(delay / 1000)}s...`);
                        await wait(delay);
                    } else {
                        // Non-retryable error
                        const errorBody = await response.json();
                        console.error("[API] Fatal error, not retrying:", errorBody);
                        reportOutput.innerHTML = `<p class="text-red-600">오류 발생: API 요청에 실패했습니다. (상태 코드: ${response.status})</p>`;
                        return null;
                    }
                } catch (error) {
                    console.error("[API] Network error:", error);
                    if (i < MAX_RETRIES - 1) {
                        const delay = Math.pow(2, i) * 1000 + (Math.random() * 1000);
                        console.warn(`[API] Retrying after network error. Waiting for ${Math.round(delay / 1000)}s...`);
                        await wait(delay);
                    } else {
                        reportOutput.innerHTML = `<p class="text-red-600">오류 발생: 네트워크 연결 또는 API 호출에 실패했습니다. 잠시 후 다시 시도해 주세요.</p>`;
                        return null;
                    }
                }
            }
            return null;
        }


        async function generateBusinessPlan(event) {
            event.preventDefault();
            
            if (!API_KEY || API_KEY === "AIzaSyCF97FLOy-6bA2Qw9K_a5fKaqkjq_nN8BE") {
                // Using custom modal instead of alert()
                reportOutput.innerHTML = `<p class="text-red-600 font-bold">❌ API 키가 설정되지 않아 생성을 시작할 수 없습니다. 스크립트 섹션에 키를 입력해 주세요.</p>`;
                return;
            }

            // 1. Gather Input Data
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // 2. Prepare UI for generation
            reportOutput.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-blue-600">
                <div class="spinner border-blue-600 border-t-blue-300 w-8 h-8"></div>
                <p class="mt-4 font-semibold text-lg">사업 계획서를 심층 리서치 중입니다...</p>
                <p class="text-sm text-gray-500 mt-1">최대 30초 정도 소요될 수 있습니다. 잠시만 기다려주세요.</p>
            </div>`;
            generateBtn.disabled = true;
            downloadPdfBtn.disabled = true;
            buttonText.textContent = "생성 중...";
            loadingSpinner.classList.remove('hidden');

            // 3. Construct System Instruction and User Query (Korean prompts for high-quality response)
            const systemInstruction = {
                parts: [{
                    text: `당신은 세계적인 수준의 전문 비즈니스 컨설턴트 및 금융 분석가입니다.
                    사용자가 제공한 정보를 바탕으로 다음과 같은 목차와 내용을 포함하는 A4 2페이지 분량의 상세하고 전문적인 사업 계획서(Business Plan) 초안을 작성하십시오.
                    
                    **[보고서 작성 가이드라인]**
                    1.  **언어:** 전체 보고서는 한국어로 작성하십시오.
                    2.  **포맷:** Markdown 형식으로 작성하며, 문법 오류가 없도록 명확하게 구성하십시오.
                    3.  **심층 리서치:** Google Search grounding tool을 사용하여 최신 시장 동향, 통계, 경쟁사 정보 등 객관적인 근거 자료를 반드시 포함하여 보고서의 깊이와 신뢰도를 높이십시오.
                    4.  **목차:** 보고서에는 다음 목차를 포함하십시오.
                        -   # 사업 계획서: [핵심 사업 아이디어 제목] (보고서 최상단 제목)
                        -   ## 1. 사업 개요 및 배경
                        -   ## 2. 시장 분석 및 타당성 (리서치 근거 필수)
                        -   ## 3. 제품/서비스 상세 기획
                        -   ## 4. 실행 전략 및 마일스톤
                        -   ## 5. 재무 예측 및 기대 효과 (구체적인 수치 제시 노력)
                        -   ## 6. 결론 및 제언
                    
                    **[사용자 입력 정보]**
                    사업 계획서 종류: ${data.planType}
                    팀/프로젝트 이름: ${data.teamName}
                    전체 목표 및 비전: ${data.goal}
                    계획 기간: ${data.period}
                    주요 과제 및 핵심 마일스톤: ${data.tasks}
                    기대 효과: ${data.expectedEffects}
                    핵심 사업 아이디어 및 상세 설명: ${data.businessIdea}

                    **[최종 지시]** 이 모든 정보를 기반으로 사용자에게 제출할 완벽한 초안 보고서를 작성하십시오. 모든 섹션은 내용이 풍부하고 전문적이어야 합니다.`
                }]
            };

            const userQuery = `위의 시스템 지침과 사용자 입력 정보를 바탕으로, [${data.teamName}]의 '핵심 사업 아이디어: ${data.businessIdea}'에 대한 상세하고 심층적인 사업 계획서 초안을 작성하고 관련 근거 자료를 반영하십시오.`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: systemInstruction,
            };

            // 4. Call API with retry logic
            const result = await fetchWithRetry(payload);

            // 5. Process and Display Result
            if (result && result.candidates && result.candidates.length > 0) {
                const candidate = result.candidates[0];
                const generatedText = candidate.content?.parts?.[0]?.text || '내용 생성에 실패했습니다.';

                let sourcesHtml = '';
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    const sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);

                    if (sources.length > 0) {
                        sourcesHtml = '<div class="citation"><strong>🔗 참고 자료 (Google Search):</strong><ul class="list-disc ml-4 mt-2">';
                        sources.forEach(source => {
                            sourcesHtml += `<li><a href="${source.uri}" target="_blank" class="text-blue-600 hover:underline text-sm">${source.title}</a></li>`;
                        });
                        sourcesHtml += '</ul></div>';
                    }
                }
                
                reportOutput.innerHTML = renderMarkdown(generatedText) + sourcesHtml;
                downloadPdfBtn.disabled = false;
            } else {
                if (!reportOutput.innerHTML.includes("오류 발생:")) {
                   reportOutput.innerHTML = `<p class="text-red-600 font-bold">❌ 결과 생성에 실패했습니다. API 키가 정확한지 확인하거나 잠시 후 다시 시도해 주세요.</p>`;
                }
                downloadPdfBtn.disabled = true;
            }

            // 6. Reset UI
            generateBtn.disabled = false;
            buttonText.textContent = "사업 계획서 생성 시작";
            loadingSpinner.classList.add('hidden');
        }

        function downloadPdf() {
            const element = document.getElementById('reportOutput');
            const teamName = document.getElementById('teamName').value || 'BusinessPlan';
            
            const opt = {
                margin: 1,
                filename: `${teamName}_사업계획서.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
                jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' }
            };

            // Use the markdown content directly for better PDF rendering
            html2pdf().set(opt).from(element).save();
        }

        form.addEventListener('submit', generateBusinessPlan);
        downloadPdfBtn.addEventListener('click', downloadPdf);
    </script>
</body>
</html>
